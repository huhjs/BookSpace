<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="recordMapper">
	
	<resultMap type="com.study.bookspace.myBook.vo.BookRecordVO" id="record">
		<id		column="RECORD_CODE"	property="recordCode"/>
		<result	column="MEM_ID"			property="memId"/>
		<result	column="BOOK_CODE" 		property="bookCode"/>
		<result	column="START_DATE"		property="startDate"/>
		<result	column="END_DATE"		property="endDate"/>
		<result	column="BOOK_REVIEW"	property="bookReview"/>
		<association property="bookVO" resultMap="bookMapper.book"></association>
	</resultMap>
	
	<!-- 최근 3개월 대여 도서 제목 목록 -->
	<select id="getBookTitleListThreeMonths" resultType="Map">
		SELECT BOOK.BOOK_CODE
			, BOOK_TITLE
		FROM BOOK_BORROW BORROW
			, BOOK BOOK
		WHERE BORROW.BOOK_CODE = BOOK.BOOK_CODE
			AND MEM_ID = #{memId}
			AND BORROW_DATE > ADD_MONTHS(SYSDATE, -3)
		GROUP BY BOOK.BOOK_CODE
			, BOOK_TITLE
		ORDER BY MAX(BORROW_DATE) DESC
	</select>
	
	<!-- 독서 기록 등록 -->
	<insert id="regBookRecord">
		INSERT INTO BOOK_RECORD (
			RECORD_CODE
			, MEM_ID
			, BOOK_CODE
			<if test="!startDate.equals('')">
			, START_DATE
			</if>
			<if test="!endDate.equals('')">
			, END_DATE
			</if>
			, BOOK_REVIEW
		) VALUES (
			(SELECT 'BK_RECORD_' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(RECORD_CODE, 11))), 0) + 1, 3, '0') FROM BOOK_RECORD)
			, #{memId}
			, #{bookCode}
			<if test="!startDate.equals('')">
			, #{startDate}
			</if>
			<if test="!endDate.equals('')">
			, #{endDate}
			</if>
			, #{bookReview}
		)
	</insert>
	
	<!-- 독서 기록 목록 -->
	<select id="              ">
		SELECT RECORD_CODE
			, BR.BOOK_CODE
			, START_DATE
			, END_DATE
			, BOOK_REVIEW
			, BOOK_TITLE
			, BOOK_AUTHOR
			, ATTACHED_FILE_NAME
		FROM BOOK_RECORD BR
			, BOOK BK
			, BOOK_IMAGE BI
		WHERE BR.BOOK_CODE = BK.BOOK_CODE
			AND BK.BOOK_CODE = BI.BOOK_CODE
			AND IS_MAIN_IMG = 'Y'
			AND MEM_ID = #{memId}
	</select>
	
</mapper>
