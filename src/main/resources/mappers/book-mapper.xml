<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bookMapper">
	<resultMap type="com.study.bookspace.book.vo.CategoryVO" id="category">
		<id 	column="BOOK_CATE_NO" 						 property="bookCateNo"/>
		<result column="BOOK_CATE_STR" 						 property="bookCateStr"/>
		<result column="BOOK_CATE_IS_USE" 					 property="bookCateIsUse"/>
	</resultMap>
	
	<resultMap type="com.study.bookspace.book.vo.BookVO" 	id="book">
		<id 	column="BOOK_CODE" 							property="bookCode"/>
		<result column="BOOK_TITLE" 						property="bookTitle"/>
		<result column="BOOK_AUTHOR" 						property="bookAuthor"/>
		<result column="BOOK_PUBLICATION_DATE"			 	property="bookPublicationDate"/>
		<result column="BOOK_PUBLISHER" 					property="bookPublisher"/>
		<result column="BOOK_INTRO" 						property="bookIntro"/>
		<result column="BOOK_CATE_NO" 						property="bookCateNo"/>
		<result column="BOOK_STOCK_CNT" 					property="bookStockCnt"/>
		<result column="ISBN" 								property="isbn"/>
		<result column="BOOK_STATUS_NO"						property="bookStatusNo"/>
		<result column="BORROW_CNT"							property="borrowCnt"/>
		<result column="RESERVE_CNT"						property="reserveCnt"/>
		<result column="AVAILABLE_STOCK_CNT"				property="availableStockCnt"/>
		<association property="categoryVO" 					resultMap="category"></association> 		
		<collection property="imgList" 						resultMap="img"></collection>
	</resultMap>
	
	<resultMap type="com.study.bookspace.book.vo.ImgVO" 	id="img">	
		<id column="BOOK_IMG_CODE" 							property="bookImgCode"/>
		<result column="BOOK_CODE" 							property="bookCode"/>
		<result column="ORIGIN_FILE_NAME" 					property="originFileName"/>
		<result column="ATTACHED_FILE_NAME" 				property="attachedFileName"/>
		<result column="IS_MAIN_IMG" 						property="isMainImg"/>
	</resultMap>
	

	<resultMap type="com.study.bookspace.book.vo.BorrowVO"	id="borrow">
		<id column="BORROW_CODE" 							property="borrowCode"/>
		<result column="BOOK_CODE" 							property="bookCode"/>
		<result column="MEM_ID" 							property="memId"/>
		<result column="BORROW_DATE" 						property="borrowDate"/>
		<result column="RETURN_DUEDATE" 					property="returnDueDate"/>
		<result column="RETURN_DATE" 						property="returnDate"/>
		<result column="BOOK_STATUS_NO"						property="bookStatusNo"/>
	</resultMap>

	
	<resultMap type="com.study.bookspace.book.vo.ReserveVO" id="reserve">
		<id column="BOOK_RESERVE_CODE" 						property="bookReserveCode"/>
		<result column="BOOK_CODE" 							property="bookCode"/>
		<result column="MEM_ID" 							property="memId"/>
		<result column="BOOK_RESERVE_DATE" 					property="bookReserveDate"/>
	</resultMap>
	
	
	
	<!-- 전체 카테고리 목록 조회 -->
	<select id="getCateListForAdmin" resultMap="category">
		SELECT BOOK_CATE_NO
			, BOOK_CATE_STR
			, BOOK_CATE_IS_USE
		FROM BOOK_CATEGORY
	</select>
	
	<!-- 도서관리 도서 상세 조회 -->
	<select id="getBookDetailForBookManage" resultMap="book">
		SELECT BOOK.BOOK_CODE
			, BOOK_TITLE
			, BOOK_AUTHOR
			, TO_CHAR(BOOK_PUBLICATION_DATE, 'YYYY-MM-DD') BOOK_PUBLICATION_DATE
			, BOOK_PUBLISHER
			, BOOK_INTRO
			, BOOK_CATE_NO
			, BOOK_STOCK_CNT
			, BOOK_IMG_CODE
			, ISBN
			, ORIGIN_FILE_NAME
			, ATTACHED_FILE_NAME
			, IS_MAIN_IMG
			, BOOK_STATUS_NO
		FROM BOOK BOOK, BOOK_IMAGE IMG
		WHERE BOOK.BOOK_CODE = IMG.BOOK_CODE
		AND BOOK.BOOK_CODE = #{bookCode}
	</select>
	
	
	<!-- 도서 정보 수정 -->
	<update id="updateBook">
		UPDATE BOOK
		SET BOOK_CODE
			, BOOK_TITLE = #{bookTitle}
			, BOOK_AUTHOR = #{bookAuthor}
			, BOOK_PUBLICATION_DATE = #{bookPublicationDate}
			, BOOK_PUBLISHER = #{bookPublisher}
			, BOOK_INTRO = #{bookIntro}
			, BOOK_CATE_NO = #{bookCateNo}
			, BOOK_STOCK_CNT = #{bookStockCnt}
			, ISBN = #{isbn}
			, BOOK_STATUS_NO = #{bookStatusNo}
	</update>
	
	
	<!-- 도서 대여  -->
	<insert id="borrowBook">
	    INSERT INTO BOOK_BORROW (
	    	BORROW_CODE
	    	, BOOK_CODE
	    	, MEM_ID
	    	, RETURN_DUEDATE
	    ) VALUES (
	    	(SELECT 'BK_BOR_' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(BORROW_CODE, 8))), 0) + 1, 3, '0')
			FROM BOOK_BORROW)
	    	, #{bookCode}
	    	, #{memId}
	    	, SYSDATE + 7
	    )
	</insert>
	
	<!-- 업데이트 쿼리 -->
	<update id="updateBorrowCnt">
		UPDATE BOOK
		SET BORROW_CNT = BORROW_CNT + 1
		WHERE BOOK_CODE = #{bookCode}
	</update>
	
	
	

	<!-- 도서 대여 개수 -->
	<select id="getBorrowAndStockCnt" resultType="Map">
	SELECT BORROW_CNT
		, BOOK_STOCK_CNT
	FROM BOOK
	WHERE BOOK_CODE = #{bookCode}
	</select>
	
	<!-- 대여 가능한 권수를 초과하거나 중복 대여한 경우 -->
	<select id="checkBorrowStatus" resultType="int">
	    SELECT COUNT(*) 
	    FROM BOOK_BORROW 
	    WHERE MEM_ID = #{memId}
	</select>
		




	<!-- 도서 반납  -->
	<update id="returnBook">
		  UPDATE BOOK_STATUS
		  SET BOOK_STATUS_NO = 1
		  WHERE BOOK_CODE = #{bookCode}
		  AND MEM_ID = #{memId}
	</update>
	
	<!-- 도서 예약  -->
	<insert id="reserveBook">
		  INSERT INTO BOOK_RESERVE (
		  	BOOK_RESERVE_CODE
		  	, BOOK_CODE
		  	, MEM_ID
		  	, BOOK_RESERVE_DATE
		  ) VALUES (
			#{bookReserveCode}
		  	, #{bookCode}
		  	, #{memId}
		  	, #{bookReserveDate}
		  )
	</insert>



	<!-- 사용 중인 카테고리 목록 -->
	<select id="getCateListInUse" resultMap="category">
		SELECT BOOK_CATE_NO
			, BOOK_CATE_STR
		FROM BOOK_CATEGORY
		WHERE BOOK_CATE_IS_USE = 'Y' 
		ORDER BY BOOK_CATE_NO
	</select>
	

	<!-- 등록될 북코드 -->
	<select id="getNextBookCode" resultType="String">
		SELECT 'BK_' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(BOOK_CODE, 4))), 0) + 1, 3, '0')
		FROM BOOK
	</select>

	
	<!-- 도서 등록  -->
	<insert id="regBook">
		INSERT INTO BOOK (
			BOOK_CODE
			, BOOK_TITLE
			, BOOK_AUTHOR
			, BOOK_PUBLICATION_DATE
			, BOOK_PUBLISHER
			, BOOK_INTRO
			, BOOK_CATE_NO
			, BOOK_STOCK_CNT
			, ISBN
		) VALUES (
			#{bookCode}
			, #{bookTitle}
			, #{bookAuthor}
			, #{bookPublicationDate}
			, #{bookPublisher}
			, #{bookIntro}
			, #{bookCateNo}
			, #{bookStockCnt}
			, #{isbn}
		)
	</insert>
	


	<!-- 이미지 등록 --> 
	<insert id="insertImges">
		INSERT INTO BOOK_IMAGE (
			BOOK_IMG_CODE
			, ORIGIN_FILE_NAME
			, ATTACHED_FILE_NAME
			, IS_MAIN_IMG
			, BOOK_CODE 
		)
		<foreach collection="imgList" item="img" index="i" separator="UNION ALL">
		SELECT (SELECT 'BK_IMG_' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(BOOK_IMG_CODE, 8))), 0) + 1 + #{i}, 3, '0')
  				  FROM BOOK_IMAGE)
			, #{img.originFileName}
			, #{img.attachedFileName}
			, #{img.isMainImg}
			, #{img.bookCode}
		FROM DUAL  
		</foreach>
	</insert>
	
	
	<!-- 목록조회 -->
	<select id="getBookListForUser" resultMap="book">
		SELECT BOOK.BOOK_CODE
			, BOOK_TITLE
			, BOOK_AUTHOR
			, BOOK_PUBLICATION_DATE
			, BOOK_PUBLISHER
			, BOOK_INTRO
			, BOOK_CATE_NO
			, BOOK_STOCK_CNT
			, ISBN
			, ATTACHED_FILE_NAME
			, BORROW_CNT
		FROM BOOK BOOK, BOOK_IMAGE IMG
		WHERE BOOK.BOOK_CODE = IMG.BOOK_CODE
		AND IS_MAIN_IMG = 'Y' 
	</select>

	
	
	<!-- 도서 상세조회  -->
	<select id="getBookDetail" resultMap="book">
		SELECT BOOK.BOOK_CODE
			, BOOK_TITLE
			, BOOK_AUTHOR
			, TO_CHAR(BOOK_PUBLICATION_DATE, 'YYYY-MM-DD') BOOK_PUBLICATION_DATE
			, BOOK_PUBLISHER
			, BOOK_INTRO
			, BOOK_CATE_NO
			, BOOK_STOCK_CNT
			, BORROW_CNT
			, ISBN
			, ATTACHED_FILE_NAME
			, IS_MAIN_IMG
		FROM BOOK BOOK, BOOK_IMAGE IMG
		WHERE BOOK.BOOK_CODE = IMG.BOOK_CODE
		AND BOOK.BOOK_CODE = #{bookCode}
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
</mapper>


